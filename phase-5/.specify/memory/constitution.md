<!--
  Sync Impact Report
  ==================
  Version change: 0.0.0 → 1.0.0 (MAJOR: initial ratification)
  Added principles:
    - I. Spec-Driven Development (No Manual Code)
    - II. Event-Driven Architecture First
    - III. Dapr Abstraction Layer
    - IV. Cloud-Native Portability
    - V. Test-First (TDD)
    - VI. Observability and Operability
    - VII. Smallest Viable Diff
  Added sections:
    - Technology Stack Constraints
    - Development Workflow
    - Governance
  Templates requiring updates:
    - .specify/templates/plan-template.md — no update needed (Constitution Check section is generic)
    - .specify/templates/spec-template.md — no update needed (requirements section is generic)
    - .specify/templates/tasks-template.md — no update needed (phase structure is generic)
  Follow-up TODOs: none
-->

# Phase 5 Advanced Cloud Deployment Constitution

## Core Principles

### I. Spec-Driven Development (No Manual Code)

All application code MUST be generated by Claude Code from specifications.
The developer acts as a system architect, NOT a syntax writer.

- Every feature starts with a markdown spec defining WHAT to build.
- Claude Code generates the implementation from the spec.
- If the output is incorrect, the developer MUST refine the spec -- not
  hand-edit the generated code.
- Prompts, iterations, and spec refinements are tracked in PHRs
  (Prompt History Records) for auditability.

### II. Event-Driven Architecture First

The system MUST use event-driven patterns for all cross-service
communication via Kafka.

- Task lifecycle events (created, updated, completed, deleted) MUST be
  published to Kafka topics.
- Specialized services (notifications, recurring tasks, audit) MUST
  consume events independently.
- Kafka is deployed via Strimzi operator on Kubernetes (self-hosted).
- For local Minikube development, Redpanda (single binary, no Zookeeper)
  is the Kafka-compatible alternative.
- If Kafka access is problematic, any Dapr-compatible PubSub component
  may substitute without code changes.

### III. Dapr Abstraction Layer

All infrastructure interactions MUST go through Dapr sidecar APIs, NOT
direct client libraries.

- **Pub/Sub**: Publish and subscribe to events via Dapr HTTP API, not
  kafka-python or aiokafka directly.
- **State Management**: Conversation state stored via Dapr state API
  backed by PostgreSQL.
- **Service Invocation**: Frontend-to-backend calls via Dapr service
  invocation with automatic discovery and mTLS.
- **Secrets**: Credentials accessed via Dapr secrets API backed by
  Kubernetes Secrets.
- **Jobs API**: Scheduled reminders use Dapr Jobs API for exact-time
  callbacks, not cron polling.
- Swapping backends (e.g., Kafka to RabbitMQ, PostgreSQL to Redis)
  MUST require only YAML component config changes, never code changes.

### IV. Cloud-Native Portability

The deployment MUST work identically on local Minikube and on a managed
cloud Kubernetes service.

- All services MUST be containerized with Docker.
- Deployment MUST use Helm charts (carried forward from Phase 4).
- Cloud target: Azure AKS, Google GKE, or Oracle OKE (Always Free
  tier recommended).
- CI/CD pipeline MUST use GitHub Actions for build, test, and deploy.
- Environment-specific configuration MUST be managed via Helm values
  files and Kubernetes ConfigMaps/Secrets -- never hardcoded.

### V. Test-First (TDD)

Tests MUST be written before implementation for all new features.

- Red-Green-Refactor cycle: write failing test, implement until green,
  then refactor.
- Contract tests for API endpoints.
- Integration tests for event-driven flows (publish event, verify
  consumer behavior).
- Kubernetes deployment tests: verify pods are running, services
  reachable, Dapr sidecars injected.
- Tests MUST pass in CI (GitHub Actions) before merge to main.

### VI. Observability and Operability

Every deployed service MUST be observable and operable.

- Structured logging MUST be enabled for all services (JSON format).
- Health check endpoints (`/health`, `/ready`) MUST exist for every
  service.
- Monitoring and logging MUST be configured on the cloud cluster
  (provider-native or Prometheus/Grafana stack).
- Dapr provides built-in distributed tracing -- it MUST be enabled.
- Runbooks for common operations (scaling, restart, log access) MUST
  be documented.

### VII. Smallest Viable Diff

Every change MUST be the minimum required to satisfy the spec.

- No over-engineering or future-proofing beyond stated requirements.
- No refactoring of unrelated code.
- No adding features not explicitly specified.
- Complexity MUST be justified against the constitution principles.
- Prefer simple, readable solutions over clever abstractions.

## Technology Stack Constraints

| Layer               | Technology                                        |
|---------------------|---------------------------------------------------|
| Frontend            | Next.js (App Router) + OpenAI ChatKit             |
| Backend             | Python FastAPI + OpenAI Agents SDK + MCP Server   |
| ORM                 | SQLModel                                          |
| Database            | Neon Serverless PostgreSQL                         |
| Authentication      | Better Auth with JWT                              |
| AI Framework        | OpenAI Agents SDK + Official MCP SDK              |
| Event Streaming     | Apache Kafka (Strimzi on K8s / Redpanda locally)  |
| Distributed Runtime | Dapr (sidecar pattern)                            |
| Containerization    | Docker                                            |
| Orchestration       | Kubernetes (Minikube local, AKS/GKE/OKE cloud)   |
| Package Manager     | Helm Charts                                       |
| CI/CD               | GitHub Actions                                    |
| Monitoring          | Provider-native or Prometheus/Grafana             |
| Spec-Driven         | Claude Code + Spec-Kit Plus                       |

**Carry-Forward Rule**: Phase 5 builds on Phases 1-4. All existing
functionality (CRUD, auth, chatbot, MCP tools, K8s deployment) MUST be
preserved. New features are additive.

**Advanced Features to Implement (Part A)**:

- Priorities and Tags/Categories (high/medium/low, work/home labels)
- Search and Filter (by keyword, status, priority, date)
- Sort Tasks (by due date, priority, alphabetically)
- Recurring Tasks (auto-reschedule repeating tasks)
- Due Dates and Time Reminders (deadlines with notifications)

**No Hardcoded Secrets**: All secrets (API keys, DB connection strings,
JWT secrets) MUST live in environment variables, Kubernetes Secrets,
or Dapr secret stores. Never committed to source control.

## Development Workflow

1. **Specify**: Write or update the feature spec in `specs/<feature>/spec.md`.
2. **Plan**: Generate the architectural plan in `specs/<feature>/plan.md`.
3. **Tasks**: Break the plan into atomic tasks in `specs/<feature>/tasks.md`.
4. **Implement**: Execute tasks via Claude Code -- no manual code writing.
5. **Test**: Verify locally on Minikube, then deploy to cloud.
6. **Record**: Every prompt interaction creates a PHR under `history/prompts/`.
7. **Decide**: Architectural decisions documented via ADRs in `history/adr/`.

**Monorepo Structure**:

```text
phase-5-advanced-cloud-deployment/
+-- .specify/              # Spec-Kit Plus config, templates, memory
+-- .claude/               # Claude Code commands
+-- specs/                 # Feature specifications
+-- history/               # PHRs and ADRs
+-- frontend/              # Next.js app
+-- backend/               # FastAPI + Agents SDK + MCP
+-- helm/                  # Helm charts for K8s deployment
+-- dapr-components/       # Dapr component YAML configs
+-- .github/workflows/     # CI/CD pipeline definitions
+-- docker-compose.yml     # Local multi-service orchestration
+-- README.md              # Setup and usage documentation
+-- CLAUDE.md              # Claude Code project instructions
```

## Governance

- This constitution is the highest-authority document for Phase 5.
  It supersedes all other practices and guidelines.
- Amendments require: (1) documented rationale, (2) version bump per
  semver, (3) Sync Impact Report update.
- All PRs and code reviews MUST verify compliance with these principles.
- Complexity beyond what the spec requires MUST be justified against
  a specific principle with documented reasoning.
- Runtime development guidance lives in `CLAUDE.md`; this constitution
  defines the non-negotiable rules.

**Version**: 1.0.0 | **Ratified**: 2026-02-07 | **Last Amended**: 2026-02-07
